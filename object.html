<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title id="pageTitle">–û–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ | Fattoria.by</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- AOS CSS -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="/css/main.css">
  <!-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è index -->
  <link rel="stylesheet" href="/css/index-combined.css">
  <!-- Yandex Maps API -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
</head>
<body>

<div id="header-placeholder"></div>

<section class="container py-5">
  <div class="row">
    <div class="col-lg-8">
      <!-- Property Gallery -->
      <div class="property-gallery mb-4" id="propertyGallery">
        <div class="main-image-container">
          <img id="mainPropertyImage" src="/images/placeholder-loading.svg" alt="–ì–ª–∞–≤–Ω–æ–µ —Ñ–æ—Ç–æ" class="img-fluid rounded">
        </div>
        <div class="thumbnail-gallery" id="thumbnailGallery">
          <!-- Thumbnails will be loaded here -->
        </div>
      </div>

      <!-- Property Info -->
      <div class="property-details-card" id="propertyDetails">
        <h1 id="propertyTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
        <p class="location" id="propertyLocation">
          <i class="fas fa-map-marker-alt"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
        </p>
        <div class="price" id="propertyPrice">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

        <div class="features-grid" id="propertyFeatures">
          <!-- Features will be loaded here -->
        </div>

        <div class="description-section">
          <h3>–û–ø–∏—Å–∞–Ω–∏–µ</h3>
          <div id="propertyDescription">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Contact Form -->
      <div class="contact-card">
        <h4>–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã –≤ –æ–±—ä–µ–∫—Ç–µ?</h4>
        <form id="contactForm" class="contact-form">
          <div class="mb-3">
            <input type="text" class="form-control" name="name" placeholder="–í–∞—à–µ –∏–º—è" required>
          </div>
          <div class="mb-3">
            <input type="tel" class="form-control" name="phone" placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω" required>
          </div>
          <div class="mb-3">
            <input type="email" class="form-control" name="email" placeholder="Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
          </div>
          <div class="mb-3">
            <textarea class="form-control" name="message" rows="3" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="agreeCheck" required>
            <label class="form-check-label" for="agreeCheck">
              –î–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            </label>
          </div>
          <button type="submit" class="btn btn-warning w-100">
            <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
          </button>
        </form>
      </div>

      <!-- Agent Info -->
      <div class="agent-card" id="agentInfo">
        <h5>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</h5>
        <div class="agent-details">
          <div class="agent-avatar">
            <i class="fas fa-user-circle fa-3x"></i>
          </div>
          <div>
            <div class="agent-name" id="agentName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="agent-phone" id="agentPhone">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
        </div>
      </div>

      <!-- Map -->
      <div class="map-card">
        <h5>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</h5>
        <div id="propertyMap" style="height: 250px; width: 100%; border-radius: 8px;"></div>
      </div>
    </div>
  </div>
</section>

<!-- Back to list button -->
<section class="container pb-5">
  <div class="text-center">
    <a href="/properties" class="btn btn-outline-primary">
      <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –æ–±—ä–µ–∫—Ç–æ–≤
    </a>
  </div>
</section>

<div id="footer-placeholder"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- AOS JS -->
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ header -->
<script src="/js/header-loader.js"></script>
<!-- Load Components JS -->
<script src="/js/load-components.js"></script>
<!-- Toast JavaScript -->
<script src="/js/toast.js"></script>

<!-- üî• –ü–ï–†–í–´–ú –∑–∞–≥—Ä—É–∂–∞–µ–º JavaScript –æ–±—ä–µ–∫—Ç–∞ -->
<script>
// üî• –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–Ø PHOTOS –í –ú–ê–°–°–ò–í
function parsePhotos(photos) {
    console.log("üì∏ Raw photos data:", photos);
    
    if (Array.isArray(photos)) {
        return photos.filter(photo => photo && photo.trim());
    }
    if (typeof photos === 'string') {
        if (photos.includes('|')) {
            return photos.split('|').filter(photo => photo && photo.trim());
        }
        try {
            const parsed = JSON.parse(photos);
            return Array.isArray(parsed) ? parsed.filter(photo => photo && photo.trim()) : [photos];
        } catch {
            return photos ? [photos] : [];
        }
    }
    return [];
}

document.addEventListener('DOMContentLoaded', function() {
  // Get property ID from URL
  let propertyUnid = null;
  
  const pathMatch = window.location.pathname.match(/\/object\/(.+)$/);
  if (pathMatch) {
    propertyUnid = pathMatch[1];
  } else {
    const urlParams = new URLSearchParams(window.location.search);
    propertyUnid = urlParams.get('unid');
  }

  if (!propertyUnid) {
    showError('ID –æ–±—ä–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }

  loadPropertyDetails(propertyUnid);
});

async function loadPropertyDetails(unid) {
  try {
    console.log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞:', unid);
    const response = await fetch(`/api/property-${unid}.json`);

    console.log("üîç API URL:", `/api/property-${unid}.json`);
    console.log("üîç Response ok:", response.ok);

    console.log("üîç Response status:", response.status);
    const property = await response.json();

    if (!property) {
      showError('–û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }

    displayPropertyDetails(property);
    initPropertyMap(property);

  } catch (error) {
    console.error('Error loading property:', error);
    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç–∞');
  }
}

function displayPropertyDetails(property) {
  console.log("üîç FULL Property data:", JSON.stringify(property, null, 2));
  console.log("üîç Property data from API:", property);

  // Update page title
  document.title = `${property.title} | Fattoria.by`;
  document.getElementById('pageTitle').textContent = `${property.title} | Fattoria.by`;

  // Update main info
  document.getElementById('propertyTitle').textContent = property.title;
  document.getElementById('propertyLocation').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${property.address || property.location || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}`;
  
  // Update price
  if (property.priceUSD && property.priceUSD !== "–¥–æ–≥–æ–≤–æ—Ä–Ω–∞—è") {
    document.getElementById('propertyPrice').textContent = property.priceUSD;
  } else if (property.priceBYN && property.priceBYN !== "–¥–æ–≥–æ–≤–æ—Ä–Ω–∞—è") {
    document.getElementById('propertyPrice').textContent = property.priceBYN;
  } else {
    document.getElementById('propertyPrice').textContent = formatPrice(property.price, property.currency);
  }

  // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ì–ê–õ–ï–†–ï–Ø
  const photos = parsePhotos(property.images);
  console.log("üì∏ Processed photos:", photos);
  
  if (photos.length > 0) {
    document.getElementById('mainPropertyImage').src = photos[0];
    document.getElementById('mainPropertyImage').alt = property.title;

    const thumbnailGallery = document.getElementById('thumbnailGallery');
    if (photos.length > 1) {
      thumbnailGallery.innerHTML = photos.slice(1, 7).map((photo, index) =>
        `<img src="${photo}" alt="–§–æ—Ç–æ ${index + 2}" data-photo="${photo}" class="thumbnail-img" style="width: 80px; height: 60px; object-fit: cover; cursor: pointer; margin: 5px; border: 2px solid transparent;">
        `
      ).join('');
    } else {
      thumbnailGallery.innerHTML = '';
    }
  } else {
    // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
    document.getElementById('mainPropertyImage').src = '/images/placeholder-loading.svg';
    document.getElementById('thumbnailGallery').innerHTML = '';
  }
  
  // Update features
  const featuresContainer = document.getElementById('propertyFeatures');
  const features = [];
  
  if (property.rooms && property.rooms !== "" && property.rooms !== "null") {
    features.push(`${property.rooms} –∫–æ–º–Ω.`);
  }
  
  if (property.area_total && property.area_total !== "" && property.area_total !== "null") {
    features.push(`${property.area_total} –º¬≤`);
  }
  
  if (property.storey && property.storeys) {
    features.push(`–≠—Ç–∞–∂: ${property.storey}/${property.storeys}`);
  }
  
  if (property.house_type && property.house_type !== "" && property.house_type !== "null") {
    const houseTypeMap = {
      "–ø": "–ü–∞–Ω–µ–ª—å–Ω—ã–π", "–∫": "–ö–∏—Ä–ø–∏—á–Ω—ã–π", "–º": "–ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π", 
      "–±": "–ë–ª–æ—á–Ω—ã–π", "–¥": "–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π"
    };
    features.push(houseTypeMap[property.house_type] || property.house_type);
  }
  
  if (property.building_year && property.building_year !== "" && property.building_year !== "null") {
    features.push(`${property.building_year} –≥.`);
  }

  if (features.length > 0) {
    featuresContainer.innerHTML = features.map(feature =>
      `<div class="feature-item">${feature}</div>`
    ).join('');
  } else {
    featuresContainer.innerHTML = '<div class="feature-item">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É—Ç–æ—á–Ω—è–µ—Ç—Å—è</div>';
  }

  // Update description
  document.getElementById('propertyDescription').textContent = property.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';

  // Update agent info
  document.getElementById('agentName').textContent = property.contact_name || '–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ';
  
  // –ò—â–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –ø–æ–ª–µ–π
  const mainPhone = property.contact_phone_1 || property.contact_phone || property.phone;
  console.log("üìû Selected phone:", mainPhone);
  
  document.getElementById('agentPhone').innerHTML = mainPhone ?
    `<a href="tel:${mainPhone}" style="color: #007bff; text-decoration: none; font-weight: 500;">
      <i class="fas fa-phone me-2"></i>${formatPhoneNumber(mainPhone)}
    </a>` :
    '<span class="text-muted">–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω</span>';
}

function formatPrice(price, currency = 'USD') {
  if (!price || price === "–¥–æ–≥–æ–≤–æ—Ä–Ω–∞—è") return '–¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É';

  const currencySymbols = {
    'USD': '$',
    'EUR': '‚Ç¨',
    'BYN': '—Ä—É–±.',
    'RUB': '‚ÇΩ'
  };

  const symbol = currencySymbols[currency] || '$';
  
  if (typeof price === 'number') {
    return new Intl.NumberFormat('ru-RU').format(price) + ' ' + symbol;
  }
  
  return price + ' ' + symbol;
}

function formatPhoneNumber(phone) {
  if (!phone) return '';
  
  // –û—á–∏—â–∞–µ–º –æ—Ç –≤—Å–µ–≥–æ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ –¥–µ—Ñ–∏—Å–æ–≤
  const cleaned = phone.replace(/[^\d-]/g, "");
  
  // –ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞ (–ø–æ–ª–Ω—ã–µ)
  if (cleaned.length === 12 && cleaned.startsWith('375')) {
    return `+${cleaned.slice(0,3)} (${cleaned.slice(3,5)}) ${cleaned.slice(5,8)}-${cleaned.slice(8,10)}-${cleaned.slice(10)}`;
  }
  
  // –†–æ—Å—Å–∏–π—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞
  if (cleaned.length === 11 && cleaned.startsWith('7')) {
    return `+${cleaned.slice(0,1)} (${cleaned.slice(1,4)}) ${cleaned.slice(4,7)}-${cleaned.slice(7,9)}-${cleaned.slice(9)}`;
  }
  
  // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –∫–æ—Ä–æ—Ç–∫–∏–π (111-90-90), –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ A1 (29)
  if (cleaned.length <= 7 || phone.match(/^\d{3}-\d{2}-\d{2}$/)) {
    return `+375 (29) ${phone}`;
  }
  
  // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ 8029...
  if (cleaned.length === 11 && cleaned.startsWith('8029')) {
    return `+375 (29) ${cleaned.slice(3,6)}-${cleaned.slice(6,8)}-${cleaned.slice(8)}`;
  }
  
  // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
  return phone;
}

function changeMainImage(src) {
  document.getElementById('mainPropertyImage').src = src;

  document.querySelectorAll('.thumbnail-gallery img').forEach(img => {
    img.classList.remove('active');
  });
  event.target.classList.add('active');
}

function initPropertyMap(property) {
  if (typeof ymaps === 'undefined') return;

  ymaps.ready(() => {
    const mapContainer = document.getElementById('propertyMap');
    if (!mapContainer) return;

    let coords = [53.9045, 27.5615]; // Default to Minsk

    if (property.lat && property.lng) {
      coords = [property.lat, property.lng];
    } else {
      ymaps.geocode(property.address || property.location || '–ú–∏–Ω—Å–∫').then((res) => {
        const firstGeoObject = res.geoObjects.get(0);
        if (firstGeoObject) {
          coords = firstGeoObject.geometry.getCoordinates();
          updateMap(coords);
        }
      });
    }

    updateMap(coords);
  });

  function updateMap(coords) {
    const map = new ymaps.Map('propertyMap', {
      center: coords,
      zoom: 15,
      controls: ['zoomControl']
    });

    const placemark = new ymaps.Placemark(coords, {
      hintContent: property.title,
      balloonContent: `${property.title}<br>${property.address || property.location}`
    });

    map.geoObjects.add(placemark);
  }
}

function showError(message) {
  const container = document.querySelector('.container');
  container.innerHTML = `
    <div class="alert alert-danger text-center" role="alert">
      <h4 class="alert-heading">–û—à–∏–±–∫–∞</h4>
      <p>${message}</p>
      <a href="/properties" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É</a>
    </div>
  `;
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('thumbnail-img')) {
    changeMainImage(e.target.dataset.photo);
  }
});
</script>

<!-- üî• –ü–û–°–õ–ï–î–ù–ò–ú –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º -->
<script src="/js/forms-handler.js"></script>

<style>
.property-gallery {
  margin-bottom: 2rem;
}

.main-image-container {
  margin-bottom: 1rem;
}

.main-image-container img {
  width: 100%;
  height: 400px;
  object-fit: cover;
  border-radius: 8px;
}

.thumbnail-gallery {
  display: flex;
  gap: 0.5rem;
  overflow-x: auto;
  padding: 0.5rem 0;
}

.thumbnail-gallery img {
  width: 80px;
  height: 60px;
  object-fit: cover;
  border-radius: 4px;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.3s;
}

.thumbnail-gallery img.active,
.thumbnail-gallery img:hover {
  opacity: 1;
}

.property-details-card {
  background: white;
  padding: 2rem;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 2rem;
}

.property-details-card h1 {
  color: #333;
  margin-bottom: 0.5rem;
}

.location {
  color: #666;
  margin-bottom: 1rem;
}

.price {
  font-size: 2rem;
  font-weight: bold;
  color: #ffc107;
  margin-bottom: 1.5rem;
}

.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 0.5rem;
  margin-bottom: 2rem;
}

.feature-item {
  background: #f8f9fa;
  padding: 0.5rem;
  border-radius: 4px;
  font-size: 0.9rem;
  text-align: center;
}

.description-section {
  margin-top: 2rem;
}

.description-section h3 {
  margin-bottom: 1rem;
  color: #333;
}

.contact-card,
.agent-card,
.map-card {
  background: white;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 1.5rem;
}

.agent-details {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.agent-avatar {
  color: #ffc107;
}

.agent-name {
  font-weight: bold;
  margin-bottom: 0.25rem;
  font-size: 1.1rem;
}

.agent-phone a {
  color: #007bff;
  text-decoration: none;
  font-size: 1.1rem;
  font-weight: 500;
}

.agent-phone a:hover {
  text-decoration: underline;
}

.map-card #propertyMap {
  margin-top: 1rem;
}

@media (max-width: 768px) {
  .property-gallery {
    margin-bottom: 1rem;
  }

  .main-image-container img {
    height: 250px;
  }

  .property-details-card {
    padding: 1rem;
  }

  .features-grid {
    grid-template-columns: 1fr;
  }
  
  .price {
    font-size: 1.5rem;
  }
}
</style>
</body>
</html>
